<?xml version="1.0" encoding="UTF-8"?>
<?define ProductName="MySQL For Excel $(var.Version)"?>
<?define Version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Name="$(var.ProductName)" Id ="*" Manufacturer="Oracle" Language="1033" Version="$(var.Version)" 
           UpgradeCode="30162E4E-2EED-48D1-BBC0-8D4A517DB004">
    <Package Id="*" InstallerVersion="200" Compressed="yes" InstallScope="perMachine" InstallPrivileges="elevated"/>

    <Upgrade Id="3106FB9F-1793-4A0D-BEBB-742952D69CDB">
      <UpgradeVersion OnlyDetect="yes" Minimum="$(var.Version)" Property="NEWERVERSIONDETECTED" IncludeMinimum="no" />
      <UpgradeVersion OnlyDetect="no" Maximum="$(var.Version)" Property="OLDERVERSIONBEINGUPGRADED" IncludeMaximum="yes" />
    </Upgrade>    
    
    <Property Id="ARPURLINFOABOUT" Value="http://www.mysql.com" />
    <Property Id="ARPURLUPDATEINFO" Value="http://dev.mysql.com"/>
    <Property Id="ARPPRODUCTICON" Value="MySQL.ForExcel.ico" />

    <Media Id="1" Cabinet="MySQLForExcel.cab" EmbedCab="yes"  CompressionLevel="high"/>

    <Condition Message="You must have Administrative rights on this machine to install [ProductName].">
      <![CDATA[ Privileged  ]]>
    </Condition>

    <!-- See if VSTO is installed -->
    <Property Id="VSTOINSTALLED">
      <RegistrySearch Id="RegVSTOSearch" Root="HKLM" Key="Software\Microsoft\VSTO Runtime Setup\v4" Name="Install" Type="raw"/>
    </Property>
    <Condition Message="The Microsoft Visual Studio Tools for Office Runtime must be installed prior to running this installation.">
      <![CDATA[Installed OR VSTOINSTALLED]]>
    </Condition>
    
    
    <!-- First make sure that .NET is installed -->
    <PropertyRef Id="NETFRAMEWORK40CLIENT"/>
    <PropertyRef Id="NETFRAMEWORK40FULL"/>
    <Condition Message="This application requires .NET Framework 4.0. Please install the .NET Framework then run this installer again.  For more information, please see http://go.microsoft.com/fwlink/?LinkId=181012">
      <![CDATA[Installed OR NETFRAMEWORK40FULL OR NETFRAMEWORK40CLIENT]]>
    </Condition>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder" Name='PFiles'>
        <Directory Id='CompanyDir' Name='MySQL'>
          <Directory Id="INSTALLDIR" Name="$(var.ProductName)">
            <Component Id='MainItems' Guid='2395C79F-4F2E-415F-9667-76CBE129D4CE'>
              <File Id="Manifest" Name="MySQL.ForExcel.dll.manifest" Source="..\Source\bin\release\MySQL.ForExcel.dll.manifest" />
              <File Id="MySql.Utility" Name="MySQL.Utility.dll" Source="..\Source\bin\release\mysql.utility.dll" />
              <File Id="MySql.Data" Name="MySql.Data.dll" Source="..\Source\bin\release\mysql.data.dll" />
              <File Id="v40Utilities" Name="Microsoft.Office.Tools.Common.v4.0.Utilities.dll" Source="..\Source\bin\release\Microsoft.Office.Tools.Common.v4.0.Utilities.dll" />
              <File Id="VSTOFile" Name="MySQL.ForExcel.vsto" Source="..\Source\bin\release\MySQL.ForExcel.vsto" />
              <File Id="AddIn" Name="MySQL.ForExcel.dll" KeyPath="yes" Source="..\Source\bin\release\MySQL.ForExcel.dll" />
              <?if $(var.IsGPL) = 1?>
              <File Id='ReadMe' Name='README' Source='README'/>
              <File Id="COPYING" Name="COPYING" Source="COPYING" DiskId="1" />
              <?else?>
              <File Id="README2" Name="README" Source="README-Commercial" DiskId="1"/>
              <?endif?>
              <RemoveFolder Id="INSTALLDIR" On="uninstall" />
            </Component>
            <Component Id="RegistryItems" Guid="*">
              <RegistryKey Id="Addin" Root="HKCU" Action="createAndRemoveOnUninstall"
                           Key="SOFTWARE\Microsoft\Office\Excel\Addins\MySQL.ForExcel">
                <RegistryValue Id="IdDescription" Name="Description" Value="MySQL.ForExcel" Type="string"/>
                <RegistryValue Id="IdFriendlyName" Name="FriendlyName" Value="MySQL.ForExcel" Type="string"/>
                <RegistryValue Id="IDLoadBehavior" Name="LoadBehavior" Value="3" Type="integer"/>
                <RegistryValue Id="IdManifest" Name="Manifest" Value="[#VSTOFile]|vstolocal" Type="string"/>
              </RegistryKey>
            </Component>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="DefaultFeature" ConfigurableDirectory="INSTALLDIR" Level="1" >
      <ComponentRef Id="MainItems" />
      <ComponentRef Id="RegistryItems"/>
    </Feature>

    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallInitialize" />
    </InstallExecuteSequence>


    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
    <UIRef Id="WixUI_MySQL" />
    <WixVariable Id="WixUIBannerBmp" Value="Bitmaps/BannrBmp.bmp"/>
    <WixVariable Id="WixUIDialogBmp" Value="Bitmaps/DlgBmp.bmp"/>
    <Icon Id="MySQL.ForExcel.ico" SourceFile="mysql-for-excel.ico" />

  </Product>
</Wix>
